require 'spec_helper'

describe "role::node" do

  context "using fact set Ubuntu-14.04-32" do
    node_facts = {"architecture"=>"i386", "augeas"=>{"version"=>"1.4.0"}, "augeasversion"=>"1.4.0", "bios_release_date"=>"12/01/2006", "bios_vendor"=>"innotek GmbH", "bios_version"=>"VirtualBox", "blockdevice_sda_model"=>"VBOX HARDDISK", "blockdevice_sda_size"=>0, "blockdevice_sda_vendor"=>"ATA", "blockdevices"=>"sda", "boardmanufacturer"=>"Oracle Corporation", "boardproductname"=>"VirtualBox", "boardserialnumber"=>"0", "chassistype"=>"Other", "dhcp_servers"=>{"eth0"=>"10.0.2.2", "system"=>"10.0.2.2"}, "disks"=>{"sda"=>{"model"=>"VBOX HARDDISK", "size"=>"20.00 GiB", "size_bytes"=>0, "vendor"=>"ATA"}}, "dmi"=>{"bios"=>{"release_date"=>"12/01/2006", "vendor"=>"innotek GmbH", "version"=>"VirtualBox"}, "board"=>{"manufacturer"=>"Oracle Corporation", "product"=>"VirtualBox", "serial_number"=>"0"}, "chassis"=>{"type"=>"Other"}, "manufacturer"=>"innotek GmbH", "product"=>{"name"=>"VirtualBox", "serial_number"=>"0", "uuid"=>"C138B01C-ADF6-4D36-8A3A-D9FCE21FF0C7"}}, "domain"=>"wifredrick.local", "facterversion"=>"3.0.2", "filesystems"=>"ext2,ext3,ext4,vfat", "fqdn"=>"localhost.wifredrick.local", "gid"=>"root", "hardwareisa"=>"i686", "hardwaremodel"=>"i686", "hostname"=>"localhost", "id"=>"root", "identity"=>{"gid"=>0, "group"=>"root", "uid"=>0, "user"=>"root"}, "interfaces"=>"eth0,lo", "ipaddress"=>"10.0.2.15", "ipaddress6"=>"fe80::a00:27ff:fe71:8945", "ipaddress6_eth0"=>"fe80::a00:27ff:fe71:8945", "ipaddress6_lo"=>"::1", "ipaddress_eth0"=>"10.0.2.15", "ipaddress_lo"=>"127.0.0.1", "is_virtual"=>true, "kernel"=>"Linux", "kernelmajversion"=>"3.16", "kernelrelease"=>"3.16.0-30-generic", "kernelversion"=>"3.16.0", "load_averages"=>{"15m"=>0.05, "1m"=>0.0, "5m"=>0.07}, "lsbdistcodename"=>"trusty", "lsbdistdescription"=>"Ubuntu 14.04.2 LTS", "lsbdistid"=>"Ubuntu", "lsbdistrelease"=>"14.04", "lsbmajdistrelease"=>"14.04", "macaddress"=>"08:00:27:71:89:45", "macaddress_eth0"=>"08:00:27:71:89:45", "manufacturer"=>"innotek GmbH", "memory"=>{"swap"=>{"available"=>"512.00 MiB", "available_bytes"=>536866816, "capacity"=>"0%", "total"=>"512.00 MiB", "total_bytes"=>536866816, "used"=>"0 bytes", "used_bytes"=>0}, "system"=>{"available"=>"414.97 MiB", "available_bytes"=>435126272, "capacity"=>"16.34%", "total"=>"496.04 MiB", "total_bytes"=>520130560, "used"=>"81.07 MiB", "used_bytes"=>85004288}}, "memoryfree"=>"414.97 MiB", "memoryfree_mb"=>414.96875, "memorysize"=>"496.04 MiB", "memorysize_mb"=>496.03515625, "mountpoints"=>{"/"=>{"available"=>"1.72 GiB", "available_bytes"=>1846272000, "capacity"=>"39.25%", "device"=>"/dev/mapper/localhost--vg-root", "filesystem"=>"ext4", "options"=>["rw", "errors=remount-ro"], "size"=>"2.83 GiB", "size_bytes"=>-1255694336, "used"=>"1.11 GiB", "used_bytes"=>1193000960}, "/boot"=>{"available"=>"200.06 MiB", "available_bytes"=>209779712, "capacity"=>"14.98%", "device"=>"/dev/sda1", "filesystem"=>"ext2", "options"=>["rw"], "size"=>"235.32 MiB", "size_bytes"=>246755328, "used"=>"35.26 MiB", "used_bytes"=>36975616}}, "mtu_eth0"=>1500, "mtu_lo"=>65536, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "netmask6_eth0"=>"ffff:ffff:ffff:ffff::", "netmask6_lo"=>"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff", "netmask_eth0"=>"255.255.255.0", "netmask_lo"=>"255.0.0.0", "network"=>"10.0.2.0", "network6"=>"fe80::", "network6_eth0"=>"fe80::", "network6_lo"=>"::1", "network_eth0"=>"10.0.2.0", "network_lo"=>"127.0.0.0", "networking"=>{"dhcp"=>"10.0.2.2", "domain"=>"wifredrick.local", "fqdn"=>"localhost.wifredrick.local", "hostname"=>"localhost", "interfaces"=>{"eth0"=>{"dhcp"=>"10.0.2.2", "ip"=>"10.0.2.15", "ip6"=>"fe80::a00:27ff:fe71:8945", "mac"=>"08:00:27:71:89:45", "mtu"=>1500, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "network"=>"10.0.2.0", "network6"=>"fe80::"}, "lo"=>{"ip"=>"127.0.0.1", "ip6"=>"::1", "mtu"=>65536, "netmask"=>"255.0.0.0", "netmask6"=>"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff", "network"=>"127.0.0.0", "network6"=>"::1"}}, "ip"=>"10.0.2.15", "ip6"=>"fe80::a00:27ff:fe71:8945", "mac"=>"08:00:27:71:89:45", "mtu"=>1500, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "network"=>"10.0.2.0", "network6"=>"fe80::"}, "operatingsystem"=>"Ubuntu", "operatingsystemmajrelease"=>"14.04", "operatingsystemrelease"=>"14.04", "os"=>{"architecture"=>"i386", "distro"=>{"codename"=>"trusty", "description"=>"Ubuntu 14.04.2 LTS", "id"=>"Ubuntu", "release"=>{"full"=>"14.04", "major"=>"14.04"}}, "family"=>"Debian", "hardware"=>"i686", "name"=>"Ubuntu", "release"=>{"full"=>"14.04", "major"=>"14.04"}, "selinux"=>{"enabled"=>false}}, "osfamily"=>"Debian", "partitions"=>{"/dev/mapper/localhost--vg-root"=>{"filesystem"=>"ext4", "mount"=>"/", "size"=>"0 bytes", "size_bytes"=>0, "uuid"=>"b31f5de0-8805-43da-b3f2-da9e51c3401b"}, "/dev/mapper/localhost--vg-swap_1"=>{"filesystem"=>"swap", "size"=>"0 bytes", "size_bytes"=>0, "uuid"=>"569bc4ac-b4e8-4e62-8503-551a63285383"}, "/dev/sda1"=>{"filesystem"=>"ext2", "mount"=>"/boot", "size"=>"243.00 MiB", "size_bytes"=>254803968, "uuid"=>"f00f661b-b4b5-4e6f-bba3-3dcacf85fd8e"}, "/dev/sda5"=>{"filesystem"=>"LVM2_member", "size"=>"19.76 GiB", "size_bytes"=>-257949696, "uuid"=>"vF1RtV-BHmi-b0UW-QR1z-tJ48-g6Tn-aGgEn7"}}, "path"=>"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/puppetlabs/bin", "physicalprocessorcount"=>1, "processor0"=>"Intel(R) Core(TM) i7-4850HQ CPU @ 2.30GHz", "processorcount"=>1, "processors"=>{"count"=>1, "isa"=>"i686", "models"=>["Intel(R) Core(TM) i7-4850HQ CPU @ 2.30GHz"], "physicalcount"=>1}, "productname"=>"VirtualBox", "puppetversion"=>"4.2.1", "ruby"=>{"platform"=>"i686-linux", "sitedir"=>"/opt/puppetlabs/puppet/lib/ruby/site_ruby/2.1.0", "version"=>"2.1.6"}, "rubyplatform"=>"i686-linux", "rubysitedir"=>"/opt/puppetlabs/puppet/lib/ruby/site_ruby/2.1.0", "rubyversion"=>"2.1.6", "selinux"=>false, "serialnumber"=>"0", "ssh"=>{"dsa"=>{"fingerprints"=>{"sha1"=>"SSHFP 2 1 1d072f5a62c6f3ecb283ca8a54906665550fb2cf", "sha256"=>"SSHFP 2 2 216358286cef61e3340afe60750513fc6bdbfc96a7190e32929fc11aeefcd375"}, "key"=>"AAAAB3NzaC1kc3MAAACBAKG/fk+L4qOg6yF5DOrNdiTsaSvD7lsYpJAFGR5AJqtmtXZsRckVuydvmsbLVDNi+P+XaO6Sr/dkFfj89vAx6gB+qZxtEbasdoUiddpjzONvjmvfzmGlFZhlptlYTSu3Ci89mY6ZergBMtGqLGh8VmcNPI54eNexasVdG4nbkcxPAAAAFQCaJGszl2tCCa6KY7GYCOisCeGwtwAAAIBDzQlFkAi7IZAQpaUS6V+1frDgnCipxXjDSZD+ObJ4Wgwrj01+vXdeHKj30mIRo7ZatXxZs2dkQHUeL0SJ/bpsdd1jOu4Mf8c+cHqSHcC4Qz2vtlARKNMXAY5vJHh7QBwaPf3/s8tWqX9lnyu1UdTjE/SgF322Nwkz9OFvCHbuuwAAAIBPA32N7qVPwEOsTBG8xVPcUXwguj6ube0n0OUsZB5i8PFjQ99nLbZce9ucLqVzPCYeClgbPrVH1MBtRc67QLKb6Kms8pseuFCtiB78j9A36PfNfTDervnF1Aw/nIb/DQImtmmDKbPhv4uniseqgSdnh2awLVy6UO7haf3Wz6maFA=="}, "ecdsa"=>{"fingerprints"=>{"sha1"=>"SSHFP 3 1 a6f44c1518708b08d997c7a97cc75b0654b098d1", "sha256"=>"SSHFP 3 2 2ccda56b2fb9bd95c2327cceaaf8f868daebb1f7dfc5bd0a9d816fff06f7b474"}, "key"=>"AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCK+3h6/GsmbpRd/xdgTi+vsoh+N6gTB5IZFpZdaJVK6H6cSwmhiEiby/3yqwQFGlSXug8aQiQJ3YZI471wScbU="}, "ed25519"=>{"fingerprints"=>{"sha1"=>"SSHFP 4 1 4ca8bd8a83038bc1339ee7037ab2043f41e4b4e7", "sha256"=>"SSHFP 4 2 7326c4dfce373f219025f41f127535f0fb9aacc221adf34e75db8eccc118ab3d"}, "key"=>"AAAAC3NzaC1lZDI1NTE5AAAAICobX2RUot4PEA4s4fTvltDWEWIXFMehgbTwvLezavoq"}, "rsa"=>{"fingerprints"=>{"sha1"=>"SSHFP 1 1 9da876f061d5f203345c99b047a48b24775f77ae", "sha256"=>"SSHFP 1 2 90ca5e6b808b9f47c78e26f9c228dab88b19536d56f6c72443b1d06502646ecf"}, "key"=>"AAAAB3NzaC1yc2EAAAADAQABAAABAQC+fl/b51y7U6i6DGQ+FwkYKIzBSVV6DcIZj+Q3BVRLzviOQIQMfNJ0wvLMKKHK96gWaGlknnU0Tn/cvVShuWbaWFBpOTLDsM2cm0usZot8+EmYGnql8D3AFMxhgWBb7pBa5KJOfJidrprXLcSjW82bKhIYbLDDVWMgaoIEVAbufOCobffpwTBYSPS4OdF3WyqNJj2B9tklkUdeUFYKkCFO/mszwSZdY+0xxTyilmyrHr8evbmoA34LREnktKFiu/I5gPXts1CdVLVzvNsMt0VM+ldLEtGPy7qvcddXy34yax538n+A6VOOBg2wpKwEsmqjkCHdq8s/2eWeeu+xGFch"}}, "sshdsakey"=>"AAAAB3NzaC1kc3MAAACBAKG/fk+L4qOg6yF5DOrNdiTsaSvD7lsYpJAFGR5AJqtmtXZsRckVuydvmsbLVDNi+P+XaO6Sr/dkFfj89vAx6gB+qZxtEbasdoUiddpjzONvjmvfzmGlFZhlptlYTSu3Ci89mY6ZergBMtGqLGh8VmcNPI54eNexasVdG4nbkcxPAAAAFQCaJGszl2tCCa6KY7GYCOisCeGwtwAAAIBDzQlFkAi7IZAQpaUS6V+1frDgnCipxXjDSZD+ObJ4Wgwrj01+vXdeHKj30mIRo7ZatXxZs2dkQHUeL0SJ/bpsdd1jOu4Mf8c+cHqSHcC4Qz2vtlARKNMXAY5vJHh7QBwaPf3/s8tWqX9lnyu1UdTjE/SgF322Nwkz9OFvCHbuuwAAAIBPA32N7qVPwEOsTBG8xVPcUXwguj6ube0n0OUsZB5i8PFjQ99nLbZce9ucLqVzPCYeClgbPrVH1MBtRc67QLKb6Kms8pseuFCtiB78j9A36PfNfTDervnF1Aw/nIb/DQImtmmDKbPhv4uniseqgSdnh2awLVy6UO7haf3Wz6maFA==", "sshecdsakey"=>"AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCK+3h6/GsmbpRd/xdgTi+vsoh+N6gTB5IZFpZdaJVK6H6cSwmhiEiby/3yqwQFGlSXug8aQiQJ3YZI471wScbU=", "sshed25519key"=>"AAAAC3NzaC1lZDI1NTE5AAAAICobX2RUot4PEA4s4fTvltDWEWIXFMehgbTwvLezavoq", "sshfp_dsa"=>"SSHFP 2 1 1d072f5a62c6f3ecb283ca8a54906665550fb2cf\nSSHFP 2 2 216358286cef61e3340afe60750513fc6bdbfc96a7190e32929fc11aeefcd375", "sshfp_ecdsa"=>"SSHFP 3 1 a6f44c1518708b08d997c7a97cc75b0654b098d1\nSSHFP 3 2 2ccda56b2fb9bd95c2327cceaaf8f868daebb1f7dfc5bd0a9d816fff06f7b474", "sshfp_ed25519"=>"SSHFP 4 1 4ca8bd8a83038bc1339ee7037ab2043f41e4b4e7\nSSHFP 4 2 7326c4dfce373f219025f41f127535f0fb9aacc221adf34e75db8eccc118ab3d", "sshfp_rsa"=>"SSHFP 1 1 9da876f061d5f203345c99b047a48b24775f77ae\nSSHFP 1 2 90ca5e6b808b9f47c78e26f9c228dab88b19536d56f6c72443b1d06502646ecf", "sshrsakey"=>"AAAAB3NzaC1yc2EAAAADAQABAAABAQC+fl/b51y7U6i6DGQ+FwkYKIzBSVV6DcIZj+Q3BVRLzviOQIQMfNJ0wvLMKKHK96gWaGlknnU0Tn/cvVShuWbaWFBpOTLDsM2cm0usZot8+EmYGnql8D3AFMxhgWBb7pBa5KJOfJidrprXLcSjW82bKhIYbLDDVWMgaoIEVAbufOCobffpwTBYSPS4OdF3WyqNJj2B9tklkUdeUFYKkCFO/mszwSZdY+0xxTyilmyrHr8evbmoA34LREnktKFiu/I5gPXts1CdVLVzvNsMt0VM+ldLEtGPy7qvcddXy34yax538n+A6VOOBg2wpKwEsmqjkCHdq8s/2eWeeu+xGFch", "swapfree"=>"512.00 MiB", "swapfree_mb"=>511.99609375, "swapsize"=>"512.00 MiB", "swapsize_mb"=>511.99609375, "system_uptime"=>{"days"=>0, "hours"=>0, "seconds"=>354, "uptime"=>"0:05 hours"}, "timezone"=>"PST", "uptime"=>"0:05 hours", "uptime_days"=>0, "uptime_hours"=>0, "uptime_seconds"=>354, "uuid"=>"C138B01C-ADF6-4D36-8A3A-D9FCE21FF0C7", "virtual"=>"virtualbox", "clientcert"=>"localhost.wifredrick.local", "clientversion"=>"4.2.1", "clientnoop"=>false}
    let(:facts) { node_facts }


    before :each do
      # Curtrently there is some code within Puppet that will try to execute
      # commands when compiling a catalog even though it shouldn't. One example is
      # the groups attribute of the user resource on AIX. If we are running on
      # Windows but pretending to be UNIX this will definitely fail so we need to
      # mock it (or vice versa)
      # Details:
      # https://github.com/puppetlabs/puppet/blob/master/lib/puppet/util/execution.rb#L191
      expected_null_file = Puppet::Util::Platform.windows? ? 'NUL' : '/dev/null'
      unless File.exist? expected_null_file
        allow(Puppet::Util::Execution).to receive(:execute).and_raise(Puppet::ExecutionFailure.new("Onceover caused this"))
      end
    end

    let(:pre_condition) {
      pp = <<-'END'
$onceover_class = 'role::node'
$onceover_node  = 'Ubuntu-14.04-32'

# Begin user-specified pre_condition

# End user-specified pre_condition


END
    }

    it { should compile }
  end
end

