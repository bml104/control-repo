require 'spec_helper'

describe "role::windows" do

  context "using fact set CentOS-5.11-64" do
    node_facts = {"architecture"=>"x86_64", "augeas"=>{"version"=>"1.4.0"}, "augeasversion"=>"1.4.0", "blockdevice_hda_size"=>21474836480, "blockdevices"=>"hda", "dhcp_servers"=>{"eth0"=>"10.0.2.2", "system"=>"10.0.2.2"}, "disks"=>{"hda"=>{"size"=>"20.00 GiB", "size_bytes"=>21474836480}}, "domain"=>"localdomain", "facterversion"=>"3.0.2", "filesystems"=>"ext2,ext3,iso9660", "fqdn"=>"localhost.localdomain", "gid"=>"root", "hardwareisa"=>"x86_64", "hardwaremodel"=>"x86_64", "hostname"=>"localhost", "id"=>"root", "identity"=>{"gid"=>0, "group"=>"root", "uid"=>0, "user"=>"root"}, "interfaces"=>"eth0,lo,sit0", "ipaddress"=>"10.0.2.15", "ipaddress6"=>"fe80::a00:27ff:fe3e:4987", "ipaddress6_eth0"=>"fe80::a00:27ff:fe3e:4987", "ipaddress6_lo"=>"::1", "ipaddress_eth0"=>"10.0.2.15", "ipaddress_lo"=>"127.0.0.1", "is_virtual"=>true, "kernel"=>"Linux", "kernelmajversion"=>"2.6", "kernelrelease"=>"2.6.18-398.el5", "kernelversion"=>"2.6.18", "load_averages"=>{"15m"=>0.0, "1m"=>0.0, "5m"=>0.0}, "lsbdistcodename"=>"Final", "lsbdistdescription"=>"CentOS release 5.11 (Final)", "lsbdistid"=>"CentOS", "lsbdistrelease"=>"5.11", "lsbmajdistrelease"=>"5", "lsbminordistrelease"=>"11", "lsbrelease"=>":core-4.0-amd64:core-4.0-ia32:core-4.0-noarch:graphics-4.0-amd64:graphics-4.0-ia32:graphics-4.0-noarch:printing-4.0-amd64:printing-4.0-ia32:printing-4.0-noarch", "macaddress"=>"08:00:27:3e:49:87", "macaddress_eth0"=>"08:00:27:3e:49:87", "memory"=>{"swap"=>{"available"=>"1023.99 MiB", "available_bytes"=>1073733632, "capacity"=>"0%", "total"=>"1023.99 MiB", "total_bytes"=>1073733632, "used"=>"0 bytes", "used_bytes"=>0}, "system"=>{"available"=>"389.45 MiB", "available_bytes"=>408363008, "capacity"=>"21.76%", "total"=>"497.78 MiB", "total_bytes"=>521961472, "used"=>"108.34 MiB", "used_bytes"=>113598464}}, "memoryfree"=>"389.45 MiB", "memoryfree_mb"=>389.4453125, "memorysize"=>"497.78 MiB", "memorysize_mb"=>497.78125, "mountpoints"=>{"/"=>{"available"=>"16.96 GiB", "available_bytes"=>18212638720, "capacity"=>"7.23%", "device"=>"/dev/mapper/VolGroup00-LogVol00", "filesystem"=>"ext3", "options"=>["rw"], "size"=>"18.28 GiB", "size_bytes"=>19632164864, "used"=>"1.32 GiB", "used_bytes"=>1419526144}, "/boot"=>{"available"=>"86.04 MiB", "available_bytes"=>90215424, "capacity"=>"12.85%", "device"=>"/dev/hda1", "filesystem"=>"ext3", "options"=>["rw"], "size"=>"98.72 MiB", "size_bytes"=>103512064, "used"=>"12.68 MiB", "used_bytes"=>13296640}}, "mtu_eth0"=>1500, "mtu_lo"=>16436, "mtu_sit0"=>1480, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "netmask6_eth0"=>"ffff:ffff:ffff:ffff::", "netmask6_lo"=>"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff", "netmask_eth0"=>"255.255.255.0", "netmask_lo"=>"255.0.0.0", "network"=>"10.0.2.0", "network6"=>"fe80::", "network6_eth0"=>"fe80::", "network6_lo"=>"::1", "network_eth0"=>"10.0.2.0", "network_lo"=>"127.0.0.0", "networking"=>{"dhcp"=>"10.0.2.2", "domain"=>"localdomain", "fqdn"=>"localhost.localdomain", "hostname"=>"localhost", "interfaces"=>{"eth0"=>{"dhcp"=>"10.0.2.2", "ip"=>"10.0.2.15", "ip6"=>"fe80::a00:27ff:fe3e:4987", "mac"=>"08:00:27:3e:49:87", "mtu"=>1500, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "network"=>"10.0.2.0", "network6"=>"fe80::"}, "lo"=>{"ip"=>"127.0.0.1", "ip6"=>"::1", "mtu"=>16436, "netmask"=>"255.0.0.0", "netmask6"=>"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff", "network"=>"127.0.0.0", "network6"=>"::1"}, "sit0"=>{"mtu"=>1480}}, "ip"=>"10.0.2.15", "ip6"=>"fe80::a00:27ff:fe3e:4987", "mac"=>"08:00:27:3e:49:87", "mtu"=>1500, "netmask"=>"255.255.255.0", "netmask6"=>"ffff:ffff:ffff:ffff::", "network"=>"10.0.2.0", "network6"=>"fe80::"}, "operatingsystem"=>"CentOS", "operatingsystemmajrelease"=>"5", "operatingsystemrelease"=>"5.11", "os"=>{"architecture"=>"x86_64", "distro"=>{"codename"=>"Final", "description"=>"CentOS release 5.11 (Final)", "id"=>"CentOS", "release"=>{"full"=>"5.11", "major"=>"5", "minor"=>"11"}, "specification"=>":core-4.0-amd64:core-4.0-ia32:core-4.0-noarch:graphics-4.0-amd64:graphics-4.0-ia32:graphics-4.0-noarch:printing-4.0-amd64:printing-4.0-ia32:printing-4.0-noarch"}, "family"=>"RedHat", "hardware"=>"x86_64", "name"=>"CentOS", "release"=>{"full"=>"5.11", "major"=>"5", "minor"=>"11"}, "selinux"=>{"enabled"=>false}}, "osfamily"=>"RedHat", "path"=>"/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/puppetlabs/bin:/root/bin", "physicalprocessorcount"=>1, "processor0"=>"Intel(R) Core(TM) i7-4850HQ CPU @ 2.30GHz", "processorcount"=>1, "processors"=>{"count"=>1, "isa"=>"x86_64", "models"=>["Intel(R) Core(TM) i7-4850HQ CPU @ 2.30GHz"], "physicalcount"=>1}, "puppetversion"=>"4.2.1", "ruby"=>{"platform"=>"x86_64-linux", "sitedir"=>"/opt/puppetlabs/puppet/lib/ruby/site_ruby/2.1.0", "version"=>"2.1.6"}, "rubyplatform"=>"x86_64-linux", "rubysitedir"=>"/opt/puppetlabs/puppet/lib/ruby/site_ruby/2.1.0", "rubyversion"=>"2.1.6", "selinux"=>false, "ssh"=>{"dsa"=>{"fingerprints"=>{"sha1"=>"SSHFP 2 1 1139f2967264a610088812d1ed3ea8db448c417d", "sha256"=>"SSHFP 2 2 ddb6064607ac29a8c83978d33e46ed56e677f27ed727341142a08156906bc9bb"}, "key"=>"AAAAB3NzaC1kc3MAAACBAK4mrAWHX3BUGyimNDl6+rtP3BXx8hvZ8UCfySeFw3vliSb5uzCLSdbcLmNZxqVrYv9skhO7wIaRFo4xwLSBPbwMffwuO8/2kIXGxkkVKnucsYmsNNaaLAgrfTR+d2lj089fs/PBDGUiJThPPsbNLMVxDEy1SOuby5FAZvNGQTlxAAAAFQCivnpYKhk5wFrpmn1mZv7ayD8HLwAAAIBQ64m92s3WWK+tdChTH2rEvfn3lJlatruRDeZaXrTuuzA7K9uJhtfqg3KAs9gtZup6vOGNJbJWZVxTG+I3jLXgA2Mfd/lAcbtA1RXnqgUITgg2/sd/TkEkCrke/NVjBaiiXVhsly63OIv/JAvq4ulmNxvUT7Pj6Fz9dKvV1elbJQAAAIBqHveIC7RZnN4bGEc+rZZ63aOYI7Pm/9OE2soVjjvGYgk9Iew9S7xwDmcrDKICqSCwzE3ISalkGAkqXKBJnKx/gKziLWdj1VOoNv16X4nVTwxaL7u9nAg1cQ+H5whnWQ+KDoLJPtc8bCpnamGMY4W89a08Qv0U5RECNhv92AQcqQ=="}, "rsa"=>{"fingerprints"=>{"sha1"=>"SSHFP 1 1 29e63bdd87c88c24251d791b474a8f3b56d581f7", "sha256"=>"SSHFP 1 2 cfc171e3db64806593cd26571556b360882507938c9a71e477478837cfa6ea9c"}, "key"=>"AAAAB3NzaC1yc2EAAAABIwAAAQEA7Z6GmWepCT3oXq1qGkIq736GM5oXr4ISMuJtGF2+8yOyM+qqvM83zgnZVkCSkNwtiLOODfzbFmmfKKdLoN30xE6oRP+hu9LH7dzRnnIwsx2DBgaX6QPdbcsIG1dnfH34PO1/AvZGRU4YRwrBSVsURR5wow6BYTs56qznYUd6VALvDg0iOLde7eniqQlVbzfLsR+GFeQ9zp9qMI4JjL17RJYBeVam0wP3cYXglE5PsMYuJwVLP6aOIFx3nQPem76bh5fyTVFsav+jsdamw+dZ7uZn6lkRlCtqyxQzFyyT3RgCUW1qVwdus42xsJm8GPojfIcqhQ3HUEDZ61D5dgZjIQ=="}}, "sshdsakey"=>"AAAAB3NzaC1kc3MAAACBAK4mrAWHX3BUGyimNDl6+rtP3BXx8hvZ8UCfySeFw3vliSb5uzCLSdbcLmNZxqVrYv9skhO7wIaRFo4xwLSBPbwMffwuO8/2kIXGxkkVKnucsYmsNNaaLAgrfTR+d2lj089fs/PBDGUiJThPPsbNLMVxDEy1SOuby5FAZvNGQTlxAAAAFQCivnpYKhk5wFrpmn1mZv7ayD8HLwAAAIBQ64m92s3WWK+tdChTH2rEvfn3lJlatruRDeZaXrTuuzA7K9uJhtfqg3KAs9gtZup6vOGNJbJWZVxTG+I3jLXgA2Mfd/lAcbtA1RXnqgUITgg2/sd/TkEkCrke/NVjBaiiXVhsly63OIv/JAvq4ulmNxvUT7Pj6Fz9dKvV1elbJQAAAIBqHveIC7RZnN4bGEc+rZZ63aOYI7Pm/9OE2soVjjvGYgk9Iew9S7xwDmcrDKICqSCwzE3ISalkGAkqXKBJnKx/gKziLWdj1VOoNv16X4nVTwxaL7u9nAg1cQ+H5whnWQ+KDoLJPtc8bCpnamGMY4W89a08Qv0U5RECNhv92AQcqQ==", "sshfp_dsa"=>"SSHFP 2 1 1139f2967264a610088812d1ed3ea8db448c417d\nSSHFP 2 2 ddb6064607ac29a8c83978d33e46ed56e677f27ed727341142a08156906bc9bb", "sshfp_rsa"=>"SSHFP 1 1 29e63bdd87c88c24251d791b474a8f3b56d581f7\nSSHFP 1 2 cfc171e3db64806593cd26571556b360882507938c9a71e477478837cfa6ea9c", "sshrsakey"=>"AAAAB3NzaC1yc2EAAAABIwAAAQEA7Z6GmWepCT3oXq1qGkIq736GM5oXr4ISMuJtGF2+8yOyM+qqvM83zgnZVkCSkNwtiLOODfzbFmmfKKdLoN30xE6oRP+hu9LH7dzRnnIwsx2DBgaX6QPdbcsIG1dnfH34PO1/AvZGRU4YRwrBSVsURR5wow6BYTs56qznYUd6VALvDg0iOLde7eniqQlVbzfLsR+GFeQ9zp9qMI4JjL17RJYBeVam0wP3cYXglE5PsMYuJwVLP6aOIFx3nQPem76bh5fyTVFsav+jsdamw+dZ7uZn6lkRlCtqyxQzFyyT3RgCUW1qVwdus42xsJm8GPojfIcqhQ3HUEDZ61D5dgZjIQ==", "swapfree"=>"1023.99 MiB", "swapfree_mb"=>1023.9921875, "swapsize"=>"1023.99 MiB", "swapsize_mb"=>1023.9921875, "system_uptime"=>{"days"=>0, "hours"=>0, "seconds"=>847, "uptime"=>"0:14 hours"}, "timezone"=>"UTC", "uptime"=>"0:14 hours", "uptime_days"=>0, "uptime_hours"=>0, "uptime_seconds"=>847, "virtual"=>"virtualbox", "clientcert"=>"localhost.localdomain", "clientversion"=>"4.2.1", "clientnoop"=>false}
    let(:facts) { node_facts }


    before :each do
      # Curtrently there is some code within Puppet that will try to execute
      # commands when compiling a catalog even though it shouldn't. One example is
      # the groups attribute of the user resource on AIX. If we are running on
      # Windows but pretending to be UNIX this will definitely fail so we need to
      # mock it (or vice versa)
      # Details:
      # https://github.com/puppetlabs/puppet/blob/master/lib/puppet/util/execution.rb#L191
      expected_null_file = Puppet::Util::Platform.windows? ? 'NUL' : '/dev/null'
      unless File.exist? expected_null_file
        allow(Puppet::Util::Execution).to receive(:execute).and_raise(Puppet::ExecutionFailure.new("Onceover caused this"))
      end
    end

    let(:pre_condition) {
      pp = <<-'END'
$onceover_class = 'role::windows'
$onceover_node  = 'CentOS-5.11-64'

# Begin user-specified pre_condition

# End user-specified pre_condition


END
    }

    it { should compile }
  end
end

